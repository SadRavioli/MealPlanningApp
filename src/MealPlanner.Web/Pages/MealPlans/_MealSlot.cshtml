@using MealPlanner.Domain.Enums
@using MealPlanner.Application.DTOs.MealPlans
@model (DayOfWeek dayOfWeek, MealType mealType, PlannedMealDto? plannedMeal, DateTime weekStartDate)

@if (Model.plannedMeal != null)
{
    <!-- Meal card with recipe -->
    <div class="meal-slot bg-white border border-primary-200 rounded-lg p-3 pb-12 shadow-sm relative min-h-[120px]"
         x-data="{ open: false, showDelete: false, flipUp: false, search: '' }"
         @@mouseenter="showDelete = true"
         @@mouseleave="showDelete = false"
         x-init="$watch('open', value => { if(value && window.innerWidth >= 1024) { const rect = $el.getBoundingClientRect(); flipUp = rect.bottom + 270 > window.innerHeight; } if(!value) { search = ''; } })">
        <h4 class="font-medium text-gray-900 text-sm mb-1">@Model.plannedMeal.RecipeName</h4>
        <p class="text-xs text-gray-600">@Model.plannedMeal.Servings servings</p>
        @if (!string.IsNullOrEmpty(Model.plannedMeal.Notes))
        {
            <p class="text-xs text-gray-500 mt-1">@Model.plannedMeal.Notes</p>
        }

        <!-- Action buttons - icon only, horizontal at bottom -->
        <div class="absolute bottom-2 left-2 right-2 flex gap-1.5 transition-opacity lg:opacity-0"
             :class="{ 'lg:!opacity-100': showDelete }">
            <a href="/Recipes/Details?id=@Model.plannedMeal.RecipeId"
               class="flex-1 inline-flex items-center justify-center p-2 text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors"
               title="View Details">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
            </a>
            <button type="button"
                    @@click="open = !open"
                    class="flex-1 inline-flex items-center justify-center p-2 text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-md transition-colors"
                    title="Change Recipe">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
            </button>
            <button type="button"
                    @@click.stop
                    hx-post="/MealPlans/Index?handler=RemoveMeal"
                    hx-vals='{"dayOfWeek": @((int)Model.dayOfWeek), "mealType": @((int)Model.mealType), "weekStartDate": "@Model.weekStartDate.ToString("yyyy-MM-dd")"}'
                    hx-target="closest .meal-slot-container"
                    hx-swap="innerHTML"
                    class="flex-1 inline-flex items-center justify-center p-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition-colors"
                    title="Remove">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>

        <!-- Recipe modal -->
        <div x-show="open"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 z-50 bg-black bg-opacity-50"
             :class="window.innerWidth >= 1024 ? 'flex items-center justify-center p-4' : ''"
             style="display: none;"
             @@click="open = false">
            <div @@click.stop
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="translate-y-full lg:scale-95"
                 x-transition:enter-end="translate-y-0 lg:scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="translate-y-0 lg:scale-100"
                 x-transition:leave-end="translate-y-full lg:scale-95"
                 class="bg-white w-full flex flex-col"
                 :class="window.innerWidth < 1024 ? 'absolute bottom-0 left-0 right-0 rounded-t-2xl max-h-[95vh]' : 'max-w-2xl max-h-[90vh] rounded-xl'">
                <!-- Modal header -->
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Select Recipe</h3>
                    <button @@click="open = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <!-- Search bar -->
                <div class="p-4 border-b">
                    <input type="text"
                           x-model="search"
                           placeholder="Search recipes..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                </div>
                <!-- Recipe list -->
                <div class="overflow-y-auto flex-1 min-h-[300px]">
                    <div hx-get="/MealPlans/Index?handler=RecipeList"
                         hx-trigger="intersect once"
                         hx-vals='{"dayOfWeek": @((int)Model.dayOfWeek), "mealType": @((int)Model.mealType), "weekStartDate": "@Model.weekStartDate.ToString("yyyy-MM-dd")"}'>
                        <p class="text-sm text-gray-500 p-4">Loading recipes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Empty slot with add button and dropdown -->
    <div class="meal-slot flex items-center justify-center h-full min-h-[120px]"
         x-data="{ open: false, flipUp: false, search: '' }"
         x-init="$watch('open', value => { if(value && window.innerWidth >= 1024) { const rect = $el.getBoundingClientRect(); flipUp = rect.bottom + 270 > window.innerHeight; } if(!value) { search = ''; } })">
        <div class="relative">
            <button type="button"
                    @@click="open = !open"
                    class="text-gray-400 hover:text-primary-500 transition-colors p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>

            <!-- Recipe modal -->
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 z-50 bg-black bg-opacity-50"
                 :class="window.innerWidth >= 1024 ? 'flex items-center justify-center p-4' : ''"
                 style="display: none;"
                 @@click="open = false">
                <div @@click.stop
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="translate-y-full lg:scale-95"
                     x-transition:enter-end="translate-y-0 lg:scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="translate-y-0 lg:scale-100"
                     x-transition:leave-end="translate-y-full lg:scale-95"
                     class="bg-white w-full flex flex-col"
                     :class="window.innerWidth < 1024 ? 'absolute bottom-0 left-0 right-0 rounded-t-2xl max-h-[95vh]' : 'max-w-2xl max-h-[90vh] rounded-xl'">
                    <!-- Modal header -->
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">Select Recipe</h3>
                        <button @@click="open = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <!-- Search bar -->
                    <div class="p-4 border-b">
                        <input type="text"
                               x-model="search"
                               placeholder="Search recipes..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                    <!-- Recipe list -->
                    <div class="overflow-y-auto flex-1 min-h-[300px]">
                        <div hx-get="/MealPlans/Index?handler=RecipeList"
                             hx-trigger="intersect once"
                             hx-vals='{"dayOfWeek": @((int)Model.dayOfWeek), "mealType": @((int)Model.mealType), "weekStartDate": "@Model.weekStartDate.ToString("yyyy-MM-dd")"}'>
                            <p class="text-sm text-gray-500 p-4">Loading recipes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
